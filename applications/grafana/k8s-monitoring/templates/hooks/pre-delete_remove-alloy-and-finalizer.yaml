---
# Source: k8s-monitoring/templates/hooks/pre-delete_remove-alloy-and-finalizer.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: grafana-k8s-monitoring-remove-alloy-and-finalizer
  namespace: default
  annotations:
    helm.sh/hook: pre-delete
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
---
# Source: k8s-monitoring/templates/hooks/pre-delete_remove-alloy-and-finalizer.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: grafana-k8s-monitoring-remove-alloy-and-finalizer
  namespace: default
  annotations:
    helm.sh/hook: pre-delete
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
rules:
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "watch", "patch"]
  - apiGroups: ["collectors.grafana.com"]
    resources: ["alloys"]
    verbs: ["get", "list", "watch", "delete"]
---
# Source: k8s-monitoring/templates/hooks/pre-delete_remove-alloy-and-finalizer.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: grafana-k8s-monitoring-remove-alloy-and-finalizer
  namespace: default
  annotations:
    helm.sh/hook: pre-delete
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
subjects:
  - kind: ServiceAccount
    name: grafana-k8s-monitoring-remove-alloy-and-finalizer
    namespace: default
roleRef:
  kind: Role
  name: grafana-k8s-monitoring-remove-alloy-and-finalizer
  apiGroup: rbac.authorization.k8s.io
---
# Source: k8s-monitoring/templates/hooks/pre-delete_remove-alloy-and-finalizer.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: grafana-k8s-monitoring-remove-alloy-and-finalizer
  namespace: default
  labels:
    app.kubernetes.io/name: grafana-k8s-monitoring-remove-alloy-and-finalizer
    app.kubernetes.io/instance: grafana-k8s-monitoring
    helm.sh/chart: k8s-monitoring-3.4.2
  annotations:
    helm.sh/hook: pre-delete
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      name: grafana-k8s-monitoring-remove-alloy-and-finalizer
      labels:
        app.kubernetes.io/name: grafana-k8s-monitoring
        app.kubernetes.io/instance: grafana-k8s-monitoring
        linkerd.io/inject: disabled
        sidecar.istio.io/inject: "false"
    spec:
      restartPolicy: Never
      nodeSelector:
        kubernetes.io/os: linux
      serviceAccountName: grafana-k8s-monitoring-remove-alloy-and-finalizer
      containers:
        - name: remove-finalizers
          image: "ghcr.io/grafana/helm-chart-toolbox-kubectl:0.1.1"
          imagePullPolicy: IfNotPresent
          command:
            - /bin/bash
            - -ce
            - |
              echo "Deleting Alloy instance: alloy/grafana-k8s-monitoring-alloy-metrics..."
              kubectl delete alloy/grafana-k8s-monitoring-alloy-metrics --ignore-not-found=true --wait
              kubectl wait --for=delete alloy/grafana-k8s-monitoring-alloy-metrics --timeout=60s || echo "Timed out waiting for deletion of alloy/grafana-k8s-monitoring-alloy-metrics or it may not exist."

              echo "Deleting Alloy instance: alloy/grafana-k8s-monitoring-alloy-singleton..."
              kubectl delete alloy/grafana-k8s-monitoring-alloy-singleton --ignore-not-found=true --wait
              kubectl wait --for=delete alloy/grafana-k8s-monitoring-alloy-singleton --timeout=60s || echo "Timed out waiting for deletion of alloy/grafana-k8s-monitoring-alloy-singleton or it may not exist."

              echo "Deleting Alloy instance: alloy/grafana-k8s-monitoring-alloy-logs..."
              kubectl delete alloy/grafana-k8s-monitoring-alloy-logs --ignore-not-found=true --wait
              kubectl wait --for=delete alloy/grafana-k8s-monitoring-alloy-logs --timeout=60s || echo "Timed out waiting for deletion of alloy/grafana-k8s-monitoring-alloy-logs or it may not exist."

              echo "Deleting Alloy instance: alloy/grafana-k8s-monitoring-alloy-receiver..."
              kubectl delete alloy/grafana-k8s-monitoring-alloy-receiver --ignore-not-found=true --wait
              kubectl wait --for=delete alloy/grafana-k8s-monitoring-alloy-receiver --timeout=60s || echo "Timed out waiting for deletion of alloy/grafana-k8s-monitoring-alloy-receiver or it may not exist."

              echo "Deleting Alloy instance: alloy/grafana-k8s-monitoring-alloy-profiles..."
              kubectl delete alloy/grafana-k8s-monitoring-alloy-profiles --ignore-not-found=true --wait
              kubectl wait --for=delete alloy/grafana-k8s-monitoring-alloy-profiles --timeout=60s || echo "Timed out waiting for deletion of alloy/grafana-k8s-monitoring-alloy-profiles or it may not exist."

              kubectl patch \
                --namespace=default \
                --type json \
                --patch='[{"op": "remove", "path": "/metadata/finalizers"}]' \
                deployment/grafana-k8s-monitoring-alloy-operator
          securityContext:
            runAsNonRoot: true
            runAsUser: 4242
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            readOnlyRootFilesystem: true
            seccompProfile:
              type: RuntimeDefault
